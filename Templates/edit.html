<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Proposta: {{ numero_proposta_original }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; font-size: 14px; }
        .header { background: linear-gradient(90deg, #007bff, #0056b3); color: white; padding: 15px 20px; text-align: center; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .logo { max-height: 70px; margin-bottom: 10px; }
        .header h1 { font-size: 1.6em; margin: 0; font-weight: 600; }
        .container { width: 90%; max-width: 900px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1.page-title { text-align: center; color: #333; margin-bottom:10px; font-size:1.7em; }
        p.sub-title { text-align: center; margin-top:0; margin-bottom:25px; color: #555; font-size:0.95em; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px; }
        .form-column label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; font-size: 0.9em;}
        input[type="text"], input[type="date"], select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 0.95em; transition: border-color 0.3s, box-shadow 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 3px rgba(0,123,255,.25); }
        textarea { resize: vertical; min-height: 80px;}
        input[readonly], select[readonly], input[disabled], select[disabled] { background-color: #e9ecef; cursor: not-allowed; opacity: 0.8; }
        .button-group { margin-top: 30px; display: flex; gap: 12px; justify-content: center; }
        .button-primary, .button-secondary { padding: 12px 22px; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-size: 1em; font-weight: bold; transition: all 0.2s ease-in-out; }
        .button-primary:hover { background-color: #0056b3; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .button-secondary:hover { background-color: #545b62; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .button-primary { background-color: #007bff; color: white; }
        .button-secondary { background-color: #6c757d; color: white; }
        .flash-messages { padding: 15px; margin-bottom: 20px; border-radius: 5px; font-size: 0.95em; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .portabilidade-only, .novo-refin-only { display: none; }
        {% if is_portabilidade %} .portabilidade-only { display: block !important; } {% else %} .novo-refin-only { display: block !important; } {% endif %}

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            h1.page-title {font-size:1.5em;}
        }
    </style>
</head>
<body>

<div class="header">
    <img src="{{ url_for('serve_logo') }}" alt="Logo da Empresa" class="logo">
    <h1>GERENCIADOR DE PROPOSTAS</h1>
</div>

<div class="container">
    <h1 class="page-title">EDITAR PROPOSTA</h1>
    <p class="sub-title">
        Número: <strong>{{ numero_proposta_original }}</strong> | 
        Aba Original: <strong>{{ sheet_name_original }}</strong>
    </p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}<div class="flash-messages">
      {% for category, message in messages %}<div class="alert alert-{{ category }}">{{ message }}</div>{% endfor %}
      </div>{% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('edit_proposal', numero_proposta_raw=numero_proposta_original) }}" id="editProposalForm">
        <div class="form-grid">
            <!-- Coluna 1 -->
            <div class="form-column">
                <div class="portabilidade-only">
                    <label for="DATA_ENVIO_CIP">DATA ENVIO CIP:</label>
                    <input type="date" id="DATA_ENVIO_CIP" name="DATA_ENVIO_CIP" value="{{ proposal.DATA_ENVIO_CIP }}">
                </div>
                <div class="novo-refin-only">
                    <label for="DATA_ENVIO_CIP_NOVO">DATA ENVIO CIP:</label>
                    <input type="date" id="DATA_ENVIO_CIP_NOVO" name="DATA_ENVIO_CIP" value="{{ proposal.DATA_ENVIO_CIP }}">
                    <label for="Data">DATA ADIÇÃO:</label>
                    <input type="date" id="Data" name="Data" value="{{ proposal.Data }}">
                </div>

                <label for="CPF">CPF:</label>
                <input type="text" id="CPF" name="CPF" value="{{ proposal.CPF }}" placeholder="000.000.000-00" maxlength="14" oninput="formatarCPF(this)" required>
                <label for="NOME_CLIENTE">NOME CLIENTE:</label>
                <input type="text" id="NOME_CLIENTE" name="NOME_CLIENTE" value="{{ proposal.NOME_CLIENTE }}" required style="text-transform: uppercase;">
                
                <div class="portabilidade-only">
                    <label for="BANCO_PROPONENTE">BANCO PROPONENTE:</label>
                    <select id="BANCO_PROPONENTE" name="BANCO_PROPONENTE">
                        <option value="">Selecione...</option>
                        {% for banco in bancos_options %}<option value="{{ banco }}" {% if banco == proposal.BANCO_PROPONENTE %}selected{% endif %}>{{ banco }}</option>{% endfor %}
                    </select>
                </div>
                <div class="novo-refin-only">
                    <label for="Banco">BANCO:</label>
                    <select id="Banco" name="Banco">
                        <option value="">Selecione...</option>
                        {% for banco in bancos_options %}<option value="{{ banco }}" {% if banco == proposal.Banco %}selected{% endif %}>{{ banco }}</option>{% endfor %}
                    </select>
                </div>

                <div class="portabilidade-only">
                    <label for="PROMOTORA">PROMOTORA:</label>
                     <select id="PROMOTORA" name="PROMOTORA">
                        <option value="">Selecione...</option>
                         {% for p in promotoras_options %}<option value="{{ p }}" {% if p == proposal.PROMOTORA %}selected{% endif %}>{{ p }}</option>{% endfor %}
                    </select>
                </div>
                <div class="novo-refin-only">
                    <label for="Promotora">PROMOTORA:</label>
                    <select id="Promotora" name="Promotora">
                        <option value="">Selecione...</option>
                        {% for p in promotoras_options %}<option value="{{ p }}" {% if p == proposal.Promotora %}selected{% endif %}>{{ p }}</option>{% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="TIPO_OPERACAO">TIPO OPERAÇÃO:</label>
                    <input type="text" id="TIPO_OPERACAO" name="TIPO_OPERACAO" value="{{ proposal.TIPO_OPERACAO }}" readonly disabled title="Tipo de operação não pode ser alterado.">
                </div>
            </div>

            <!-- Coluna 2 -->
            <div class="form-column">
                <div class="portabilidade-only">
                    <label for="ORGAO">ÓRGÃO:</label>
                    <select id="ORGAO" name="ORGAO">
                        <option value="">Selecione...</option>
                        {% set orgaos_list = ["INSS", "AERONÁUTICA", "ESTADO", "MARINHA", "MUNICÍPIO", "SIAPE", "EXÉRCITO"] %}
                        {% for o_item in orgaos_list %}<option value="{{ o_item }}" {% if o_item == proposal.ORGAO %}selected{% endif %}>{{ o_item }}</option>{% endfor %}
                    </select>
                </div>

                <div class="portabilidade-only">
                    <label for="VALOR_PARCELA">VALOR PARCELA (R$):</label>
                    <input type="text" id="VALOR_PARCELA" name="VALOR_PARCELA" value="{{ proposal.VALOR_PARCELA }}" oninput="formatarMoeda(this)">
                </div>
                <div class="novo-refin-only">
                    <label for="Valor Parcela">VALOR PARCELA (R$):</label>
                    <input type="text" id="Valor Parcela" name="Valor Parcela" value="{{ proposal['Valor Parcela'] }}" oninput="formatarMoeda(this)">
                </div>
                
                <div class="portabilidade-only">
                    <label for="BANCO_ORIGEM_DIVIDA">BANCO ORIGEM DÍVIDA:</label>
                    <select id="BANCO_ORIGEM_DIVIDA" name="BANCO_ORIGEM_DIVIDA">
                        <option value="">Selecione...</option>
                        {% for banco_o in bancos_origem_options %}<option value="{{ banco_o }}" {% if banco_o == proposal.BANCO_ORIGEM_DIVIDA %}selected{% endif %}>{{ banco_o }}</option>{% endfor %}
                    </select>
                    <label for="SALDO_DEVEDOR_PREVISTO">SALDO DEVEDOR PREVISTO (R$):</label>
                    <input type="text" id="SALDO_DEVEDOR_PREVISTO" name="SALDO_DEVEDOR_PREVISTO" value="{{ proposal.SALDO_DEVEDOR_PREVISTO }}" oninput="formatarMoeda(this)">
                    <label for="VALOR_LIQUIDO_PREVISTO">VALOR LÍQUIDO PREVISTO (R$):</label>
                    <input type="text" id="VALOR_LIQUIDO_PREVISTO" name="VALOR_LIQUIDO_PREVISTO" value="{{ proposal.VALOR_LIQUIDO_PREVISTO }}" oninput="formatarMoeda(this)">
                </div>
                 <div class="novo-refin-only">
                    <label for="Vl. contrato">VL. CONTRATO (R$):</label>
                    <input type="text" id="Vl. contrato" name="Vl. contrato" value="{{ proposal['Vl. contrato'] }}" oninput="formatarMoeda(this)">
                </div>

                <div class="portabilidade-only">
                    <label for="SALDO_RETORNADO_CIP">SALDO RETORNADO CIP (R$):</label>
                    <input type="text" id="SALDO_RETORNADO_CIP" name="SALDO_RETORNADO_CIP" value="{{ proposal.SALDO_RETORNADO_CIP }}" oninput="formatarMoeda(this)">
                    <label for="VALOR_LIQUIDO_ATUALIZADO">VALOR LÍQUIDO ATUALIZADO (R$):</label>
                    <input type="text" id="VALOR_LIQUIDO_ATUALIZADO" name="VALOR_LIQUIDO_ATUALIZADO" value="{{ proposal.VALOR_LIQUIDO_ATUALIZADO }}" oninput="formatarMoeda(this)">
                </div>
            </div>
        </div>

        <!-- Campos Comuns fora do grid -->
        <label for="NUMERO_PROPOSTA_EDIT">Nº PROPOSTA:</label>
        <input type="text" id="NUMERO_PROPOSTA_EDIT" name="{{ 'Nº Proposta' if not is_portabilidade else 'NUMERO_PROPOSTA' }}" 
               value="{{ proposal['Nº Proposta'] if not is_portabilidade else proposal.NUMERO_PROPOSTA }}" 
               required style="text-transform: uppercase;" maxlength="30">
        
        <label for="LINK_FORMALIZACAO">LINK FORMALIZAÇÃO:</label>
        <input type="text" id="LINK_FORMALIZACAO" name="LINK_FORMALIZACAO" value="{{ proposal.LINK_FORMALIZACAO | default('', true) }}">
        
        <label for="OBSERVACOES">OBSERVAÇÕES:</label>
        <textarea id="OBSERVACOES" name="OBSERVACOES" rows="3" maxlength="200">{{ proposal.OBSERVACOES | default('', true) }}</textarea>

        <div class="portabilidade-only">
             <label for="DATA_RETORNO_PREVISTA">DATA RETORNO PREVISTA:</label>
             <input type="date" id="DATA_RETORNO_PREVISTA" name="DATA_RETORNO_PREVISTA" value="{{ proposal.DATA_RETORNO_PREVISTA }}" readonly disabled title="Calculado automaticamente">
             <label for="DATA_RETORNO_CIP">DATA RETORNO CIP:</label>
             <input type="date" id="DATA_RETORNO_CIP" name="DATA_RETORNO_CIP" value="{{ proposal.DATA_RETORNO_CIP }}" readonly disabled title="Atualizado via tela principal">
        </div>
        
        <div>
            <label for="STATUS_ATUAL_DISPLAY">STATUS ATUAL:</label>
            <input type="text" id="STATUS_ATUAL_DISPLAY" name="STATUS_ATUAL_DISPLAY" 
                   value="{{ proposal.STATUS_PROPOSTA if is_portabilidade else proposal.Status }}" readonly disabled 
                   title="Status é atualizado na tela principal.">
        </div>

        <div class="button-group">
            <button type="submit" class="button-primary"><i class="fas fa-save"></i> SALVAR ALTERAÇÕES</button>
            <a href="{{ url_for('index') }}" class="button-secondary"><i class="fas fa-times"></i> CANCELAR</a>
        </div>
    </form>
</div>

<script>
    function desformatarMoeda(valorFormatado) {
        if (!valorFormatado || typeof valorFormatado !== 'string') return '';
        return valorFormatado.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
    }

    function formatarCPF(campo) {
        let v = campo.value.replace(/\D/g, '').slice(0, 11);
        if (v.length > 9) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        else if (v.length > 6) v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
        else if (v.length > 3) v = v.replace(/(\d{3})(\d{1,3})/, '$1.$2');
        campo.value = v;
    }

    function formatarMoeda(campo) {
        let v = campo.value.replace(/\D/g, '');
        if (v === "") { campo.value = ""; return; }
        v = (parseFloat(v) / 100).toFixed(2) + '';
        v = v.replace('.', ',');
        v = v.replace(/(\d)(?=(\d{3})+(?:,\d\d)$)/g, '$1.');
        campo.value = "R$ " + v;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const cpfInput = document.getElementById('CPF');
        if (cpfInput) { formatarCPF(cpfInput); cpfInput.addEventListener('input', (e) => formatarCPF(e.target)); }

        const moneyInputs = document.querySelectorAll('input[oninput="formatarMoeda(this)"]');
        
        moneyInputs.forEach(input => {
            if (input.value && !input.value.startsWith("R$")) { formatarMoeda(input); }
        });

        const form = document.getElementById('editProposalForm');
        if (form) {
            form.addEventListener('submit', function(event) {
                moneyInputs.forEach(input => {
                    if (input.value) { input.value = desformatarMoeda(input.value); }
                });
            });
        }
        
        document.querySelectorAll("input[type='text']").forEach(el => {
            const noUppercase = ['CPF', 'LINK_FORMALIZACAO'];
            let isMoney = Array.from(moneyInputs).includes(el);
            if (!noUppercase.includes(el.name) && !isMoney) {
                 el.style.textTransform = 'uppercase';
                 if (el.value) el.value = el.value.toUpperCase(); 
                 el.addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
            }
        });
    });
</script>

</body>
</html>
