<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Propostas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; font-size: 14px; color: #333; }
        .header { background: linear-gradient(90deg, #007bff, #0056b3); color: white; padding: 15px 20px; text-align: center; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .logo { max-height: 70px; margin-bottom: 10px; }
        .header h1 { font-size: 1.6em; margin: 0; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .container { width: 95%; max-width: 1700px; margin: 20px auto; background-color: white; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
        h2 { color: #0056b3; margin-top: 0; margin-bottom: 20px; font-size: 1.4em; text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-column label { margin-top: 10px; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 0.9em; }
        input[type="text"], input[type="date"], select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; transition: all 0.2s ease-in-out; }
        input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 3px rgba(0,123,255,.25); }
        textarea { resize: vertical; min-height: 70px; }
        button, .button-link { background-color: #007bff; color: white; padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.95em; margin-top: 10px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.2s, transform 0.2s; font-weight: 500; }
        button:hover, .button-link:hover { background-color: #0056b3; transform: translateY(-2px); }
        button i, .button-link i { margin-right: 5px; }
        .button-secondary { background-color: #6c757d; } .button-secondary:hover { background-color: #5a6268; }
        .button-danger { background-color: #dc3545; } .button-danger:hover { background-color: #c82333; }
        
        .table-wrapper { overflow-x: auto; max-height: 500px; margin-top: 15px; border: 1px solid #ddd; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th, td { border: 1px solid #e9ecef; padding: 8px 12px; text-align: left; white-space: nowrap; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; font-weight: 600; color: #495057; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        tr:hover { background-color: #e9f5ff; }

        .filter-form { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; align-items: flex-end; padding: 20px; background-color:#f8f9fa; border: 1px solid #dee2e6; border-radius:8px;}
        .filter-form > div { flex: 1 1 220px; }
        .filter-form label { font-size: 0.9em; font-weight:500; }
        .filter-form input, .filter-form select { margin-bottom: 0; }
        .filter-buttons { flex-basis: 100%; display:flex; gap:10px; margin-top:10px; justify-content:flex-start;}
        
        .actions-container, .actions-container-simple { display: flex; gap: 8px; align-items: center; justify-content: flex-start; }
        .icon-button { background: none; border: none; cursor: pointer; padding: 5px; margin: 0; font-size: 1.25em; color: #6c757d; transition: color 0.2s, transform 0.2s;}
        .icon-button:hover { transform: scale(1.2); }
        .edit-icon:hover { color: #007bff; } .delete-icon:hover { color: #dc3545; } .update-icon:hover, .update-icon-simple:hover { color: #28a745; } .reanalyze-icon:hover { color: #ffc107;}

        .add-form-portabilidade-field, .add-form-novo-refin-field { display: none; }
        body.show-add-portabilidade .add-form-portabilidade-field { display: block; }
        body.show-add-novo .add-form-novo-refin-field { display: block; }
        body.show-add-refinanciamento .add-form-novo-refin-field { display: block; }
        
        .table-danger td { background-color: #f5c6cb !important; }
        .table-warning td { background-color: #ffeeba !important; }
        
        .flash-message { padding: 15px; margin: 15px auto; border-radius: 5px; font-size: 0.95em; width:95%; max-width:1700px; box-sizing:border-box;}
        .flash-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .flash-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .flash-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;}

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border: 1px solid #ddd; width: 90%; max-width: 550px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
        .close-modal { color: #777; float: right; font-size: 30px; font-weight: bold; line-height:0.7;}
        .close-modal:hover, .close-modal:focus { color: #000; text-decoration: none; cursor: pointer; }
        .modal h3 { margin-top: 0; margin-bottom:20px; font-size:1.3em; color:#333; border-bottom:1px solid #eee; padding-bottom:10px;}
        .modal label { margin-top: 15px; }
        .modal-buttons { margin-top:20px; display:flex; justify-content:flex-end; gap:10px;}
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideIn { from {transform: translateY(-50px);} to {transform: translateY(0);} }

        [title]:hover::after { content: attr(title); position: absolute; background: #333; color: white; padding: 5px 8px; border-radius: 3px; font-size: 0.8em; white-space: nowrap; z-index: 1001; margin-left: 5px; }

        @media (max-width: 768px) {
            .form-grid, .filter-form { grid-template-columns: 1fr; flex-direction: column; }
            .filter-form > div { min-width: 100%; }
            .filter-buttons {flex-direction:column;}
            th, td { padding: 6px; font-size: 0.85em; }
        }
    </style>
</head>
<body id="pageBody"> 
    <div class="header">
        <img src="{{ url_for('serve_logo') }}" alt="Logo" class="logo">
        <h1>GERENCIADOR DE PROPOSTAS</h1>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="container">
        <h2><i class="fas fa-plus-circle"></i> ADICIONAR NOVA PROPOSTA</h2>
        <form action="{{ url_for('add_proposal') }}" method="post" id="addProposalForm">
            <label for="add_tipo_operacao">TIPO DE OPERAÇÃO:</label>
            <select id="add_tipo_operacao" name="TIPO_OPERACAO_ADD" onchange="toggleAddFormFields()" required>
                <option value="">Selecione...</option>
                <option value="Portabilidade">Portabilidade</option>
                <option value="Novo">Novo</option>
                <option value="Refinanciamento">Refinanciamento</option>
            </select>
        
            <div class="form-grid">
                <!-- Coluna 1 -->
                <div class="form-column">
                    <!-- CAMPOS PARA PORTABILIDADE -->
                    <div class="add-form-portabilidade-field">
                        <label for="add_data_envio_cip_port">DATA ENVIO CIP:</label>
                        <input type="date" id="add_data_envio_cip_port" name="DATA_ENVIO_CIP">
                    </div>
                    <!-- CAMPOS PARA NOVO/REFIN -->
                    <div class="add-form-novo-refin-field">
                        <label for="add_data_envio_cip_novo_refin">DATA ENVIO CIP:</label>
                        <input type="date" id="add_data_envio_cip_novo_refin" name="DATA_ENVIO_CIP_NOVO_REFIN_ADD">
                    </div>

                    <label for="add_cpf">CPF:</label>
                    <input type="text" id="add_cpf" name="CPF_ADD" placeholder="000.000.000-00" maxlength="14" oninput="formatarCPF(this)" required>

                    <label for="add_nome_cliente">NOME CLIENTE:</label>
                    <input type="text" id="add_nome_cliente" name="NOME_CLIENTE_ADD" required style="text-transform: uppercase;">

                    <div class="add-form-portabilidade-field">
                        <label for="add_banco_proponente_port">BANCO PROPONENTE:</label>
                        <select id="add_banco_proponente_port" name="BANCO_PROPONENTE">
                            <option value="">Selecione...</option>
                            {% for banco in bancos_options %}<option value="{{ banco }}">{{ banco }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="add-form-novo-refin-field">
                        <label for="add_banco_novo_refin">BANCO:</label>
                        <select id="add_banco_novo_refin" name="BANCO_NOVO_REFIN_ADD">
                            <option value="">Selecione...</option>
                            {% for banco in bancos_options %}<option value="{{ banco }}">{{ banco }}</option>{% endfor %}
                        </select>
                    </div>
                    
                    <div class="add-form-portabilidade-field">
                        <label for="add_promotora_port">PROMOTORA:</label>
                         <select id="add_promotora_port" name="PROMOTORA">
                            <option value="">Selecione...</option>
                            {% for p in promotoras_options %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
                        </select>
                    </div>
                     <div class="add-form-novo-refin-field">
                        <label for="add_promotora_novo_refin">PROMOTORA:</label>
                        <select id="add_promotora_novo_refin" name="PROMOTORA_NOVO_REFIN_ADD">
                            <option value="">Selecione...</option>
                            {% for p in promotoras_options %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <!-- Coluna 2 -->
                <div class="form-column">
                    <div class="add-form-portabilidade-field">
                        <label for="add_orgao">ÓRGÃO:</label>
                        <select id="add_orgao" name="ORGAO">
                            <option value="INSS" selected>INSS</option> <option value="AERONÁUTICA">AERONÁUTICA</option> <option value="ESTADO">ESTADO</option> <option value="MARINHA">MARINHA</option> <option value="MUNICÍPIO">MUNICÍPIO</option> <option value="SIAPE">SIAPE</option> <option value="EXÉRCITO">EXÉRCITO</option>
                        </select>
                        <label for="add_valor_parcela_port">VALOR PARCELA (R$):</label>
                        <input type="text" id="add_valor_parcela_port" name="VALOR_PARCELA" oninput="formatarMoeda(this)">
                        <label for="add_banco_origem_divida">BANCO ORIGEM DÍVIDA:</label>
                        <select id="add_banco_origem_divida" name="BANCO_ORIGEM_DIVIDA">
                            <option value="">Selecione...</option>
                            {% for banco in bancos_origem_options %}<option value="{{ banco }}">{{ banco }}</option>{% endfor %}
                        </select>
                    </div>
                     <div class="add-form-novo-refin-field">
                        <label for="add_valor_parcela_novo_refin">VALOR PARCELA (R$):</label>
                        <input type="text" id="add_valor_parcela_novo_refin" name="VALOR_PARCELA_NOVO_REFIN_ADD" oninput="formatarMoeda(this)">
                    </div>

                    <div class="add-form-portabilidade-field">
                        <label for="add_saldo_devedor_previsto">SALDO DEVEDOR PREVISTO (R$):</label>
                        <input type="text" id="add_saldo_devedor_previsto" name="SALDO_DEVEDOR_PREVISTO" oninput="formatarMoeda(this)">
                        <label for="add_valor_liquido_previsto">VALOR LÍQUIDO PREVISTO (R$):</label>
                        <input type="text" id="add_valor_liquido_previsto" name="VALOR_LIQUIDO_PREVISTO" oninput="formatarMoeda(this)">
                    </div>

                    <div class="add-form-novo-refin-field">
                        <label for="add_valor_contrato_novo_refin">VALOR CONTRATO (R$):</label>
                        <input type="text" id="add_valor_contrato_novo_refin" name="VALOR_CONTRATO_NOVO_REFIN_ADD" oninput="formatarMoeda(this)">
                    </div>

                    <div class="add-form-portabilidade-field">
                        <label for="add_numero_proposta_port">Nº PROPOSTA:</label>
                        <input type="text" id="add_numero_proposta_port" name="NUMERO_PROPOSTA" style="text-transform: uppercase;" maxlength="30">
                    </div>
                    <div class="add-form-novo-refin-field">
                        <label for="add_numero_proposta_novo_refin">Nº PROPOSTA:</label>
                        <input type="text" id="add_numero_proposta_novo_refin" name="NUMERO_PROPOSTA_NOVO_REFIN_ADD" style="text-transform: uppercase;" maxlength="30">
                    </div>
                    
                    <div class="add-form-portabilidade-field">
                        <label for="add_link_formalizacao_port">LINK FORMALIZAÇÃO:</label>
                        <input type="text" id="add_link_formalizacao_port" name="LINK_FORMALIZACAO">
                    </div>
                    <div class="add-form-novo-refin-field">
                        <label for="add_link_formalizacao_novo_refin">LINK FORMALIZAÇÃO:</label>
                        <input type="text" id="add_link_formalizacao_novo_refin" name="LINK_FORMALIZACAO_NOVO_REFIN_ADD">
                    </div>
                </div>
            </div>
            
            <div class="add-form-portabilidade-field">
                <label for="add_observacoes_port">OBSERVAÇÕES:</label>
                <textarea id="add_observacoes_port" name="OBSERVACOES" rows="2" maxlength="200"></textarea>
            </div>
            <div class="add-form-novo-refin-field">
                <label for="add_observacoes_novo_refin">OBSERVAÇÕES:</label>
                <textarea id="add_observacoes_novo_refin" name="OBSERVACOES_NOVO_REFIN_ADD" rows="2" maxlength="200"></textarea>
            </div>
            
            <button type="submit"><i class="fas fa-plus-circle"></i> ADICIONAR PROPOSTA</button>
        </form>
    </div>
    
    <div class="container">
        <h2><i class="fas fa-filter"></i> FILTRAR PROPOSTAS</h2>
        <form action="{{ url_for('index') }}" method="get" class="filter-form">
            <div><label for="filter_nome_cliente">Nome Cliente:</label><input type="text" id="filter_nome_cliente" name="filter_nome_cliente" value="{{ filter_nome_cliente }}" style="text-transform: uppercase;"></div>
            <div><label for="filter_cpf">CPF:</label><input type="text" id="filter_cpf" name="filter_cpf" value="{{ filter_cpf }}" placeholder="000.000.000-00" maxlength="14" oninput="formatarCPF(this)"></div>
            <div><label for="filter_banco_proponente">Banco:</label>
                <select id="filter_banco_proponente" name="filter_banco_proponente">
                    <option value="">Todos</option>
                    {% for banco in bancos_options %}<option value="{{ banco }}" {% if filter_banco_proponente == banco %}selected{% endif %}>{{ banco }}</option>{% endfor %}
                </select>
            </div>
            <div><label for="filter_promotora">Promotora:</label>
                <select id="filter_promotora" name="filter_promotora">
                    <option value="">Todas</option>
                    {% for promotora in promotoras_options %}<option value="{{ promotora }}" {% if filter_promotora == promotora %}selected{% endif %}>{{ promotora }}</option>{% endfor %}
                </select>
            </div>
            <div class="filter-buttons">
                <button type="submit"><i class="fas fa-search"></i> Filtrar</button>
                <button type="button" class="button-secondary" onclick="window.location.href='{{ url_for('index') }}'"><i class="fas fa-broom"></i> Limpar</button>
            </div>
        </form>
    </div>
    
    {% for sheet_title in sheet_names %}
    <div class="container">
        <h2>{{ sheet_title }}</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        {% set cols = get_sheet_columns(sheet_title) %}
                        {% for col in cols %}
                           <th>{{ col.replace("_", " ").title() }}</th>
                        {% endfor %}
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% set items = dfs.get(sheet_title, []) %}
                    {% if items %}
                        {% for item in items %}
                        <tr class="{{ item.row_class }}">
                           {% for col in cols %}
                                {% set value = item[col] %}
                                {% if "LINK" in col.upper() and value %}
                                    <td><a href="{{ value }}" target="_blank" title="{{ value }}">Ver Link</a></td>
                                {% elif "OBSERVACOES" in col.upper() %}
                                    <td title="{{ value }}">{{ value[:25] }}{% if value|length > 25 %}...{% endif %}</td>
                                {% else %}
                                    <td>{{ value }}</td>
                                {% endif %}
                           {% endfor %}
                            <td>
                                <div class="actions-container-simple">
                                    <a href="{{ url_for('edit_proposal', numero_proposta_raw=item.numero_proposta_id) }}" class="icon-button edit-icon" title="Editar"><i class="fas fa-edit"></i></a>
                                    <button type="button" class="icon-button delete-icon" title="Excluir" onclick="openDeleteModal('{{ item.original_sheet }}', '{{ item.original_index }}', '{{ item.numero_proposta_id }}')"><i class="fas fa-trash-alt"></i></button>
                                    
                                    {% if sheet_title == sheet_names[0] %} <!-- NOVOS E REFIN -->
                                        <button type="button" class="icon-button update-icon" title="Atualizar Status" onclick="openStatusModal('{{ item.original_sheet }}', '{{ item.original_index }}', '{{ item.numero_proposta_id }}', '{{ item.Status }}', 'novos_refin', '{{ item.OBSERVACOES }}')"><i class="fas fa-sync-alt"></i></button>
                                    {% elif sheet_title == sheet_names[1] %} <!-- AGUARDANDO -->
                                        <button type="button" class="icon-button update-icon" title="Atualizar Status/Mover" onclick="openAguardandoStatusModal('{{ item.original_sheet }}', '{{ item.original_index }}', '{{ item.numero_proposta_id }}', '{{ item.SALDO_RETORNADO_CIP }}', '{{ item.VALOR_LIQUIDO_ATUALIZADO }}', '{{ item.OBSERVACOES }}', '{{ item.STATUS_PROPOSTA }}' )"><i class="fas fa-exchange-alt"></i></button>
                                    {% elif sheet_title in [sheet_names[2], sheet_names[3]] %} <!-- RETORNADOS / NÃO RETORNADOS -->
                                         <button type="button" class="icon-button reanalyze-icon" title="Mover para Reanálise" onclick="openReanaliseModal('{{ item.original_sheet }}', '{{ item.original_index }}', '{{ item.numero_proposta_id }}', '{{ item.OBSERVACOES }}')"><i class="fas fa-undo"></i></button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="{{ cols|length + 1 }}" style="text-align:center; padding: 15px;">Nenhuma proposta encontrada.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}

    <!-- MODAIS -->
    <!-- Modal para Atualizar Status de AGUARDANDO SALDO -->
    <div id="aguardandoStatusModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('aguardandoStatusModal')">&times;</span>
            <h3>Atualizar Proposta <strong id="modalNumPropostaAguardando" style="color:#007bff;"></strong></h3>
            <form id="aguardandoStatusForm" method="POST">
                <input type="hidden" name="action" id="aguardandoModalAction">
                
                <div id="aguardandoRetornadoFields" style="display:none;">
                    <label for="modalSaldoRetornado">SALDO RETORNADO CIP (R$):</label>
                    <input type="text" id="modalSaldoRetornado" name="MODAL_SALDO_RETORNADO_CIP" oninput="formatarMoeda(this)">
                    <label for="modalLiquidoAtualizado">VALOR LÍQUIDO ATUALIZADO (R$):</label>
                    <input type="text" id="modalLiquidoAtualizado" name="MODAL_VALOR_LIQUIDO_ATUALIZADO" oninput="formatarMoeda(this)">
                </div>

                <label for="modalAguardandoNewStatus">ATUALIZAR STATUS PARA:</label>
                <select id="modalAguardandoNewStatus" name="NEW_STATUS_PROPOSTA_MODAL">
                    <option value="">Manter Status Atual</option>
                    {% for st in status_options_port %}<option value="{{ st }}">{{ st }}</option>{% endfor %}
                </select>
                <label for="modalObservacoesAguardando">OBSERVAÇÕES:</label>
                <textarea id="modalObservacoesAguardando" name="OBSERVACOES_MODAL" rows="3" maxlength="200"></textarea>
                <div class="modal-buttons">
                    <button type="button" class="button-primary" onclick="submitAguardandoStatus('retornado')"><i class="fas fa-check-circle"></i> SALDO RETORNADO</button>
                    <button type="button" class="button-secondary" onclick="submitAguardandoStatus('nao_retornado')"><i class="fas fa-times-circle"></i> NÃO RETORNADO</button>
                    <button type="button" class="button-secondary" onclick="submitAguardandoStatus('update_status_only')"><i class="fas fa-save"></i> APENAS ATUALIZAR</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Reanálise -->
    <div id="reanaliseModal" class="modal"><div class="modal-content">
        <span class="close-modal" onclick="closeModal('reanaliseModal')">&times;</span>
        <h3>Reanálise (<span id="modalNumPropostaReanalise" style="color:#007bff;"></span>)</h3>
        <p>Confirmar mover esta proposta para "AGUARDANDO SALDO"?</p>
        <form id="reanaliseForm" method="POST">
            <input type="hidden" name="action" value="reanalise">
            <label for="modalObservacoesReanalise">OBSERVAÇÕES:</label>
            <textarea id="modalObservacoesReanalise" name="OBSERVACOES_MODAL" rows="3" maxlength="200"></textarea>
            <div class="modal-buttons">
                <button type="submit"><i class="fas fa-undo"></i> SIM, MOVER</button>
                <button type="button" class="button-secondary" onclick="closeModal('reanaliseModal')">Cancelar</button>
            </div>
        </form>
    </div></div>
    
    <!-- Modal para Excluir -->
    <div id="deleteModal" class="modal"><div class="modal-content">
        <span class="close-modal" onclick="closeModal('deleteModal')">&times;</span>
        <h3>Confirmar Exclusão</h3>
        <p>Tem certeza que deseja excluir permanentemente a proposta <strong id="modalNumPropostaDelete" style="color:#dc3545;"></strong>?</p>
        <form id="deleteForm" method="POST">
             <input type="hidden" name="action" value="delete_proposal">
            <div class="modal-buttons">
                <button type="submit" class="button-danger"><i class="fas fa-trash-alt"></i> EXCLUIR</button>
                <button type="button" class="button-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
            </div>
        </form>
    </div></div>

    <!-- Modal para Status de Novos/Refin -->
    <div id="statusNovosRefinModal" class="modal"><div class="modal-content">
        <span class="close-modal" onclick="closeModal('statusNovosRefinModal')">&times;</span>
        <h3>Atualizar Status (<span id="modalNumPropostaNovosRefin" style="color:#007bff;"></span>)</h3>
        <form id="statusNovosRefinForm" method="POST">
            <input type="hidden" name="action" value="update_status_only">
            <label for="modalStatusNovosRefinSelect">NOVO STATUS:</label>
            <select id="modalStatusNovosRefinSelect" name="NEW_STATUS_PROPOSTA_MODAL" required>
                 {% for st_nr in status_options_novos_refin %}<option value="{{ st_nr }}">{{ st_nr }}</option>{% endfor %}
            </select>
            <label for="modalObservacoesNovosRefin">OBSERVAÇÕES:</label>
            <textarea id="modalObservacoesNovosRefin" name="OBSERVACOES_MODAL" rows="3" maxlength="200"></textarea>
            <div class="modal-buttons">
                <button type="submit"><i class="fas fa-save"></i> ATUALIZAR</button>
                <button type="button" class="button-secondary" onclick="closeModal('statusNovosRefinModal')">Cancelar</button>
            </div>
        </form>
    </div></div>

<script>
    // --- FUNÇÕES DE FORMATAÇÃO ---
    function formatarCPF(campo) { let v=campo.value.replace(/\D/g,'').slice(0,11); if(v.length>9)v=v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4'); else if(v.length>6)v=v.replace(/(\d{3})(\d{3})(\d{1,3})/,'$1.$2.$3'); else if(v.length>3)v=v.replace(/(\d{3})(\d{1,3})/,'$1.$2'); campo.value=v; }
    function formatarMoeda(campo) { let v=campo.value.replace(/\D/g,''); if(v==="") {campo.value="";return;} v=(parseFloat(v)/100).toFixed(2)+''; v=v.replace('.',','); v=v.replace(/(\d)(?=(\d{3})+(?:,\d\d)$)/g,'$1.'); campo.value="R$ "+v; }
    function desformatarMoeda(v) { return v ? v.replace("R$", "").replace(/\./g, "").replace(",", ".").trim() : ''; }

    // --- LÓGICA DO FORMULÁRIO DE ADICIONAR ---
    function toggleAddFormFields() {
        const tipo = document.getElementById('add_tipo_operacao').value;
        const body = document.getElementById('pageBody');
        body.className = '';
        if (tipo === 'Portabilidade') body.classList.add('show-add-portabilidade');
        else if (tipo === 'Novo' || tipo === 'Refinanciamento') body.classList.add('show-add-novo');
    }

    // --- LÓGICA DOS MODAIS ---
    function openModal(modalId) { document.getElementById(modalId).style.display = "block"; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = "none"; }

    function openAguardandoStatusModal(sheet, index, numProposta, saldoAtual, liquidoAtual, obsAtual, statusAtual) {
        const form = document.getElementById('aguardandoStatusForm');
        form.action = `/update_status/${sheet}/${index}`;
        document.getElementById('modalNumPropostaAguardando').textContent = numProposta;
        document.getElementById('modalSaldoRetornado').value = saldoAtual && !["None","nan",""].includes(saldoAtual.trim()) ? format_currency(saldoAtual) : '';
        document.getElementById('modalLiquidoAtualizado').value = liquidoAtual && !["None","nan",""].includes(liquidoAtual.trim()) ? format_currency(liquidoAtual) : '';
        document.getElementById('modalObservacoesAguardando').value = obsAtual && obsAtual !== "None" ? obsAtual : '';
        document.getElementById('modalAguardandoNewStatus').value = ""; // Limpa o select
        document.getElementById('aguardandoRetornadoFields').style.display = 'none'; // Esconde por padrão
        openModal('aguardandoStatusModal');
    }

    function submitAguardandoStatus(actionType) {
        const form = document.getElementById('aguardandoStatusForm');
        form.querySelector('input[name="action"]').value = actionType;
        if (actionType === 'retornado') {
            document.getElementById('aguardandoRetornadoFields').style.display = 'block';
            return; // Espera o usuário preencher e clicar de novo ou em outro botão
        }
        const saldoInput = document.getElementById('modalSaldoRetornado');
        const liquidoInput = document.getElementById('modalLiquidoAtualizado');
        if (saldoInput.value) saldoInput.value = desformatarMoeda(saldoInput.value);
        if (liquidoInput.value) liquidoInput.value = desformatarMoeda(liquidoInput.value);
        form.submit();
    }
    
    function openReanaliseModal(sheet, index, numProposta, obsAtual) {
        document.getElementById('reanaliseForm').action = `/update_status/${sheet}/${index}`;
        document.getElementById('modalNumPropostaReanalise').textContent = numProposta;
        document.getElementById('modalObservacoesReanalise').value = obsAtual && obsAtual !== "None" ? obsAtual : '';
        openModal('reanaliseModal');
    }

    function openDeleteModal(sheet, index, numProposta) {
        document.getElementById('deleteForm').action = `/update_status/${sheet}/${index}`;
        document.getElementById('modalNumPropostaDelete').textContent = numProposta;
        openModal('deleteModal');
    }

    function openStatusModal(sheet, index, numProposta, currentStatus, type, obsAtual) {
        if (type === 'novos_refin') {
            const form = document.getElementById('statusNovosRefinForm');
            form.action = `/update_status/${sheet}/${index}`;
            document.getElementById('modalNumPropostaNovosRefin').textContent = numProposta;
            document.getElementById('modalStatusNovosRefinSelect').value = currentStatus;
            document.getElementById('modalObservacoesNovosRefin').value = obsAtual && obsAtual !== "None" ? obsAtual : '';
            openModal('statusNovosRefinModal');
        } 
    }

    // Inicialização ao carregar a página
    document.addEventListener('DOMContentLoaded', toggleAddFormFields);
</script>
</body>
</html>
